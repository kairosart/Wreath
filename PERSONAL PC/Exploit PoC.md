Ok, so we know what is likely to happen when we access this page:

- It will probably ask us for creds.
- We'll be able to upload image files.
- There are two filters in play to stop us from uploading other kinds of files.
- Both of these filters can be bypassed.

Perfect -- let's access the page!

Let's head to the `/resources` directory.

As expected, we are met with a request for authentication:

![[Exploit PoC-20250128210433691.webp]]

We can assume that the username here is _probably_ either `Thomas` or `twreath` -- both of which we have already seen. We also already have one of Thomas' passwords, stolen from the Git Server using Mimikatz ([[Stabilisation & Post Exploitation]]).

See if you can login using these usernames with that password!

![[Screenshot from 2025-01-28 21-10-09.png]]

How cute -- a page to allow Thomas to upload pictures of his beloved cat, Ruby.

Try uploading a legitimate image -- see if you can access it!

We already know how to bypass the first filter -- simply changing the extension to `.jpeg.php` should be enough.

The second filter is slightly harder, but doable.

As the `getimagesize()` function is checking for attributes that only an image will have, we need to give it what it wants: an image.

In other words, we need to upload a genuine image file which contains a PHP webshell _somewhere_. If this file has a `.php` file extension then it will be executed by the website as a PHP file, meaning all we need to do is force a webshell into the file and we're golden.

The easiest place to stick the shell is in the exifdata for the image -- specifically in the `Comment` field to keep it nicely out of the way.

Take a regular image (i.e. download a jpeg of your choice off the internet, keeping it safe for work) and rename it to `test-USERNAME.jpeg.php`, substituting in your own TryHackMe username.

![[Exploit PoC-20250130192745580.webp]]

> [!Note]
>You may need to install exiftool before use (`sudo apt install exiftool`).

Here we can see all of the exifdata for the image. Exiftool also allows us to edit this information, which makes it a great choice for the exploit we're going to carry out.

Before we actually start inserting payloads into the image, however, there is one more thing to take into account. There is antivirus software running on this target. We don't know which AV Thomas uses, but we know that there will be protections enabled on this target. We don't know how strict the Antivirus software he uses is -- for all we know it will pick up any kind of default PHP webshell that we upload, alerting him to how close we are to compromising his host. It might not, but why take the chance? For this reason we will not be uploading a live payload in this task. Instead we will create a proof of concept here, then upload a live payload when we have completed the PHP Obfuscation task in the AV Evasion section of the network.

Bearing this in mind, let's create our PoC!

We'll be using the following PHP payload for this:  
`<?php echo "<pre>Test Payload</pre>"; die();?>   `

This is completely harmless and ergo should not get picked up by the AV. It does give us confirmation that this is likely to work, however, and stages the way for the actual webshell upload.

To add this to our image we once again use exiftool:  
`exiftool -Comment="<?php echo \"<pre>Test Payload</pre>\"; die(); ?>" test-USERNAME.jpeg.php`

![[Exploit PoC-20250130193041747.webp]]

Now try uploading the file and accessing it in your browser!

![[Exploit PoC-20250130193118071.webp]]

> [!Note]
>The HTML form is configured to only allow image uploads through the GUI, so don't be alarmed if you don't see your script in your working directory. Just change "All Supported Types" at the bottom right of the Window to "All Files".

![[Exploit PoC-20250130193227913.webp]]

![[Exploit PoC-20250130193255187.webp]]

We have the ability to execute arbitrary PHP code on the system!

**Next step: ** [[AV EVASION/Introduction|Introduction]]
